<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: header" />
<body>
<!-- jQuery -->
<!-- iamport.payment.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.1.5.js"></script>
<div th:replace="fragments/bodyHeader :: bodyHeader"/>
<div class="container">
  <h1 class="h1">결제 페이지 정보</h1>
  <form role="form" action="/order" method="post">
    <h3 class="h3">구매자 정보</h3>
    <table class="table"  style="font-size: 20px;  margin: 40px">
      <thead>
      <tr>
        <th>이름</th>
        <th>이메일</th>
        <th>휴대폰 번호</th>
      </tr>
      </thead>
      <tbody>
      <tr>
        <td>John</td>
        <td>Doe</td>
        <td>john@example.com</td>
      </tr>
      </tbody>

    </table>


    <h3 class="h3">받는사람 정보</h3>
    <button type="button" class="btn btn-primary">배송지 변경</button>
    <table class="table"  style="font-size: 20px; margin: 40px">
      <thead>
      <tr>
        <th>이름</th>
        <th>연락처</th>
        <th>배송 주소</th>
        <th>배송 요청사항</th>
      </tr>
      </thead>
      <tbody>

      <tr>
        <td>John</td>
        <td>Doe</td>
        <td>john@example.com</td>
        <td>john@example.com</td>
      </tr>

      </tbody>

    </table>


    <span style="font-size: 25px" th:text="${#numbers.formatDecimal(ctotal,3,'POINT',0,'COMMA')} + '원'"></span>
    <button class="btn btn-primary" type="button" onClick="requestPay2()">결제하기</button>
  </form>
  <br/>
  <div th:replace="fragments/footer :: footer" />
</div> <!-- /container -->

<script defer>
  const IMP = window.IMP;
  IMP.init("imp96240372");

  function requestPay2() {
    // IMP.request_pay(param, callback) 결제창 호출
    let random = "";
    for(let i=0;i<3;i++){
      random += Math.floor(Math.random() * 10)
    }
    let orderId = Date.now() + random.toString();
    IMP.request_pay({ // param
      pg: "kakaopay",
      pay_method: "kakaopay",
      merchant_uid: orderId, // 주문번호
      name: "청바지",
      amount: 6900,
      buyer_email: "hairhold@gmail.com",
      buyer_name: "조명윤",
      buyer_tel: "010-7420-7786",
      buyer_addr: "서울특별시 강남구 신사동",
      buyer_postcode: "01181"
    }, function(rsp) {
      console.log(rsp);
      // 결제검증
      $.ajax({
        type : "POST",
        url : "/verifyIamport/" + rsp.imp_uid,
        dataType: 'json',
        contentType: 'application/json',
        data: JSON.stringify({
          uid   : rsp.imp_uid,
          price : rsp.paid_amount,
          email : rsp.buyer_email
          //기타 필요한 데이터가 있으면 추가 전달
        })
      }).done(function(data) {

        console.log(data);

        // 위의 rsp.paid_amount 와 data.response.amount를 비교한후 로직 실행 (import 서버검증)
        if(rsp.paid_amount == data.response.amount){
          alert("결제 및 결제검증완료");
        } else {
          alert("결제 실패");
        }
      });
    });
  }

</script>


</body>
</html>